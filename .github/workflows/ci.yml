name: Despligue con Railway, la re sufri

on:
  push:
    branches:
      - main
      
jobs:
    build:
      
        runs-on: ubuntu-latest

        steps:

          - name: Checkout code
            uses: actions/checkout@v3

          - name: Set up Node.js
            uses: actions/setup-node@v3
            with:
              node-version: '18' # Asegúrate de usar la versión de Node.js que necesita tu proyecto

          - name: Install dependencies
            run: npm install

          - name: Run tests
            run: npm test
    deploy:
        runs-on: ubuntu-latest
        needs: build
        if: success() # Solo se ejecutará si el job 'build' pasa
          
        steps:
          
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Log in to docker hub 
            uses: docker/login-action@v3
            with:
                username: ${{ secrets.DOCKER_USERNAME}}
                password: ${{ secrets.DOCKER_PASSWORD}}
      
          - name: build and  Push Docker image
            uses: docker/build-push-action@v3
            with:
                push: true
                tags: ${{secrets.DOCKER_USERNAME}}/caballito:latest

          - name: Pull Docker image
            run: docker pull ${{secrets.DOCKER_USERNAME}}/caballito:latest
            
          - name: Install Railway # 1
            run: npm i -g @railway/cli
          
          - name: Deploy 
            run: railway up --service hopeful-gentleness
            env:
                RAILWAY_TOKEN: ${{ secrets.RAILWAY_DOCKER_PRODUCTION }}

    